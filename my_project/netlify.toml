# netlify.toml
# 位于你的项目根目录 (my_project/)

[build]
  # 这是 Netlify 在构建时要执行的命令。
  # 1. 首先，安装 requirements.txt 中列出的所有 Python 依赖。
  # 2. 接着，创建 Netlify Function 期望的目录结构。
  # 3. 将你的 FastAPI 应用相关文件复制到该结构中。
  # 4. **新增：创建 publish 目录，即使它是空的。**
  command = """
  pip install -r requirements.txt && \
  mkdir -p netlify/functions/main && \
  cp main.py netlify/functions/main/main.py && \
  cp -r templates netlify/functions/main/templates && \
  cp -r static netlify/functions/main/static && \
  cp requirements.txt netlify/functions/main/requirements.txt && \
  mkdir -p build_output  # <-- 必须新增这一行！
  """
  # Netlify 期望你的函数文件放在这个目录下。
  # 注意：这个路径是相对于 Base directory 的。
  functions = "netlify/functions"
  # publish 目录通常用于静态网站的输出。
  # 由于我们的整个应用都是一个函数，这里可以指定一个虚拟的目录。
  # Netlify 会构建这个目录，但主要流量会通过函数。
  # 注意：这个路径是相对于 Base directory 的。
  publish = "build_output"

# 重定向规则：将所有请求都发送到我们的 'main' Netlify Function
# 这是让整个 FastAPI 应用作为一个函数运行的关键。
[[redirects]]
  from = "/*"
  to = "/.netlify/functions/main" # 'main' 是你的函数名，它会查找 netlify/functions/main/main.py
  status = 200
  force = true # <-- 推荐添加，确保所有请求都重定向到函数
